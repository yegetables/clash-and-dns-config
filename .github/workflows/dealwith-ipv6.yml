name: Process IPv6 Addresses (Enhanced)

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/process-ipv6.yml'

permissions:
  contents: write

jobs:
  process-ipv6:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download and process IPv6
      run: |
        set -e
        
        # é…ç½®
        SOURCE_URL="https://raw.githubusercontent.com/ymyuuu/IPDB/refs/heads/main/BestCF/bestcfv6.txt"
        ORIGINAL_FILE="bestcfv6_original.txt"
        PROCESSED_FILE="ipv6_dealwith_ips.txt"
        
        echo "ğŸ”— ä¸‹è½½æº: $SOURCE_URL"
        
        # ä¸‹è½½åŸå§‹æ–‡ä»¶
        curl -s -f "$SOURCE_URL" -o "$ORIGINAL_FILE" || {
          echo "âŒ ä¸‹è½½å¤±è´¥"
          exit 1
        }
        
        # éªŒè¯æ–‡ä»¶å†…å®¹
        if [ ! -s "$ORIGINAL_FILE" ]; then
          echo "âŒ ä¸‹è½½çš„æ–‡ä»¶ä¸ºç©º"
          exit 1
        fi
        
        echo "ğŸ“Š åŸå§‹æ–‡ä»¶ä¿¡æ¯:"
        echo "  è¡Œæ•°: $(wc -l < "$ORIGINAL_FILE")"
        echo "  å¤§å°: $(wc -c < "$ORIGINAL_FILE") å­—èŠ‚"
        
        # æ”¹è¿›çš„ IPv6 å¤„ç†è„šæœ¬
        cat > process_ipv6.sh << 'EOF'
#!/bin/bash

input_file="$1"
output_file="$2"

# æ›´ä¸¥æ ¼çš„ IPv6 æ­£åˆ™è¡¨è¾¾å¼
# åŒ¹é…ä»¥ä¸‹æ ¼å¼:
# 1. å®Œæ•´çš„ IPv6 (8ç»„4ä½åå…­è¿›åˆ¶)
# 2. å‹ç¼©æ ¼å¼ (åŒ…å« ::)
# 3. çœç•¥å‰å¯¼é›¶
ipv6_regex='^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$'

# å¤„ç†æ–‡ä»¶
processed_count=0
> "$output_file"  # æ¸…ç©ºè¾“å‡ºæ–‡ä»¶

while IFS= read -r line || [ -n "$line" ]; do
    # å»é™¤å‰åç©ºç™½å­—ç¬¦
    line_clean=$(echo "$line" | xargs)
    
    # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
    if [ -z "$line_clean" ] || [[ "$line_clean" == \#* ]]; then
        continue
    fi
    
    # æ£€æŸ¥æ˜¯å¦ä¸º IPv6 åœ°å€
    if [[ "$line_clean" =~ $ipv6_regex ]]; then
        echo "[$line_clean]:443" >> "$output_file"
        ((processed_count++))
    else
        # å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„ IPv6ï¼Œå¯ä»¥é€‰æ‹©è®°å½•åˆ°æ—¥å¿—
        echo "âš ï¸  è·³è¿‡æ— æ•ˆè¡Œ: $line_clean" >&2
    fi
done < "$input_file"

echo "âœ… å¤„ç†å®Œæˆ: è¾“å‡ºäº† $processed_count ä¸ª IPv6 åœ°å€"
EOF
        
        chmod +x process_ipv6.sh
        
        # æ‰§è¡Œå¤„ç†
        echo "ğŸ”„ æ­£åœ¨å¤„ç† IPv6 åœ°å€..."
        ./process_ipv6.sh "$ORIGINAL_FILE" "$PROCESSED_FILE"
        
        # æ˜¾ç¤ºç»“æœ
        echo "ğŸ“‹ ç»“æœé¢„è§ˆ:"
        echo "--- å‰5è¡Œ ---"
        head -5 "$PROCESSED_FILE"
        echo "--- å5è¡Œ ---"
        tail -5 "$PROCESSED_FILE"
        
    - name: Commit changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        if git diff --quiet; then
          echo "ğŸ”„ æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          git add -A
          git commit -m "chore: update processed IPv6 addresses [$(date +%Y-%m-%d)]"
          git push
          echo "âœ… å·²æäº¤æ›´æ–°"
        fi
