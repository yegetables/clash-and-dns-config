name: Process Multiple IPv6 Sources

on:
  schedule:
    - cron: '56 3 * * *'  
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/dealwith-ipv6.yml'
      - 'best_cf_ipv6.txt'

permissions:
  contents: write

jobs:
  process-ipv6:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Read and process multiple sources
      run: |
        set -e
        
        # é…ç½®æ–‡ä»¶
        SOURCE_LIST="best_cf_ipv6.txt"
        TEMP_FILE="ipv6_temp.txt"
        OUTPUT_FILE="ipv6_dealwith_ips.txt"
        PROCESSED_SOURCES="processed_sources.txt"
        
        # æ¸…ç©ºä¸´æ—¶æ–‡ä»¶å’Œè¾“å‡ºæ–‡ä»¶
        > "$TEMP_FILE"
        > "$OUTPUT_FILE"
        > "$PROCESSED_SOURCES"
        
        echo "ğŸ“‹ å¼€å§‹å¤„ç†æºæ–‡ä»¶: $SOURCE_LIST"
        echo "æºæ–‡ä»¶å†…å®¹:"
        cat "$SOURCE_LIST"
        echo ""
        
        # è®¡æ•°å™¨
        source_count=0
        total_ip_count=0
        
        # é€è¡Œè¯»å–æºæ–‡ä»¶
        while IFS= read -r line || [ -n "$line" ]; do
          # æ¸…ç†è¡Œï¼šå»é™¤å‰åç©ºæ ¼ã€å¼•å·
          clean_line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' -e 's/^"//' -e 's/"$//' -e "s/^'//" -e "s/'$//")
          
          # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
          if [ -z "$clean_line" ] || [[ "$clean_line" == \#* ]]; then
            echo "è·³è¿‡: $line"
            continue
          fi
          
          source_count=$((source_count + 1))
          echo "å¤„ç†æº $source_count: $clean_line"
          
          # åˆ¤æ–­æ˜¯URLè¿˜æ˜¯ç›´æ¥IPåœ°å€
          if [[ "$clean_line" =~ ^https?:// ]] || [[ "$clean_line" =~ ^raw\.githubusercontent\.com ]]; then
            # æ˜¯URLé“¾æ¥
            echo "  ç±»å‹: URLé“¾æ¥"
            echo "  ä¸‹è½½ä¸­..."
            
            # å°è¯•ä¸‹è½½
            if curl -s -f "$clean_line" >> "$TEMP_FILE"; then
              downloaded_count=$(wc -l < "$TEMP_FILE" | awk -v prev=$total_ip_count '{print $1 - prev}')
              echo "  ä¸‹è½½æˆåŠŸ: æ–°å¢ $downloaded_count ä¸ªåœ°å€"
              echo "[URL] $clean_line -> $downloaded_count åœ°å€" >> "$PROCESSED_SOURCES"
            else
              echo "  âŒ ä¸‹è½½å¤±è´¥: $clean_line"
              echo "[URLå¤±è´¥] $clean_line" >> "$PROCESSED_SOURCES"
            fi
            
          elif [[ "$clean_line" =~ [a-fA-F0-9:]+ ]]; then
            # å¯èƒ½æ˜¯ç›´æ¥IPv6åœ°å€
            echo "  ç±»å‹: ç›´æ¥IPv6åœ°å€"
            echo "$clean_line" >> "$TEMP_FILE"
            echo "[ç›´æ¥IP] $clean_line" >> "$PROCESSED_SOURCES"
            echo "  æ·»åŠ ç›´æ¥åœ°å€: $clean_line"
            
          else
            echo "  âš ï¸  æ— æ³•è¯†åˆ«çš„æ ¼å¼: $clean_line"
            echo "[æœªçŸ¥æ ¼å¼] $clean_line" >> "$PROCESSED_SOURCES"
          fi
          
          total_ip_count=$(wc -l < "$TEMP_FILE")
          echo "  å½“å‰ç´¯è®¡åœ°å€æ•°: $total_ip_count"
          echo ""
          
        done < "$SOURCE_LIST"
        
        # å»é‡å¹¶å¤„ç†IPv6åœ°å€
        if [ -s "$TEMP_FILE" ]; then
          echo "ğŸ”„ æ­£åœ¨å¤„ç†å¹¶å»é‡IPv6åœ°å€..."
          
          # å»é‡å¹¶æ’åº
          sort -u "$TEMP_FILE" > "${TEMP_FILE}.sorted"
          mv "${TEMP_FILE}.sorted" "$TEMP_FILE"
          
          # ä½¿ç”¨sedå¤„ç†IPv6åœ°å€æ ¼å¼
          sed -E '/^$/d; s/^([0-9a-fA-F:]*::[0-9a-fA-F:]+|[0-9a-fA-F:]+::[0-9a-fA-F:]*|([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4})$/[\1]:443/' "$TEMP_FILE" > "$OUTPUT_FILE"
          
          # ç»Ÿè®¡æœ€ç»ˆç»“æœ
          original_count=$(wc -l < "$TEMP_FILE")
          final_count=$(wc -l < "$OUTPUT_FILE")
          
          echo "ğŸ“Š å¤„ç†å®Œæˆç»Ÿè®¡:"
          echo "  å¤„ç†çš„æºæ•°é‡: $source_count"
          echo "  å»é‡å‰åœ°å€æ•°: $total_ip_count"
          echo "  å»é‡ååœ°å€æ•°: $original_count"
          echo "  æœ€ç»ˆè¾“å‡ºåœ°å€æ•°: $final_count"
          
        else
          echo "âŒ æ²¡æœ‰å¤„ç†ä»»ä½•æœ‰æ•ˆçš„IPv6åœ°å€"
          echo "ç©ºæ–‡ä»¶" > "$OUTPUT_FILE"
        fi
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f "$TEMP_FILE"

    - name: Generate README
      run: |
        # ç”Ÿæˆ README æ–‡ä»¶
        echo "# IPv6 Address Processing Results" > README_IPV6.md
        echo "" >> README_IPV6.md
        echo "## æ›´æ–°ä¿¡æ¯" >> README_IPV6.md
        echo "- **æœ€åæ›´æ–°æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> README_IPV6.md
        echo "- **æºé…ç½®æ–‡ä»¶**: [best_cf_ipv6.txt](best_cf_ipv6.txt)" >> README_IPV6.md
        echo "- **å¤„ç†åæ–‡ä»¶**: [ipv6_dealwith_ips.txt](ipv6_dealwith_ips.txt)" >> README_IPV6.md
        echo "" >> README_IPV6.md
        echo "## ç»Ÿè®¡ä¿¡æ¯" >> README_IPV6.md
        echo "- æœ€ç»ˆIPv6åœ°å€æ•°: $(wc -l < ipv6_dealwith_ips.txt)" >> README_IPV6.md
        echo "" >> README_IPV6.md
        
        # å¦‚æœæœ‰å¤„ç†æºè®°å½•ï¼Œæ·»åŠ å¤„ç†è¯¦æƒ…
        if [ -f processed_sources.txt ] && [ -s processed_sources.txt ]; then
          echo "## å¤„ç†è¯¦æƒ…" >> README_IPV6.md
          cat processed_sources.txt >> README_IPV6.md
          echo "" >> README_IPV6.md
        fi
        
        echo "## æ–‡ä»¶æ ¼å¼ç¤ºä¾‹" >> README_IPV6.md
        echo "### æºé…ç½®æ–‡ä»¶æ ¼å¼" >> README_IPV6.md
        echo '```' >> README_IPV6.md
        echo '# æ”¯æŒå¤šç§æ ¼å¼ï¼Œæ¯è¡Œä¸€ä¸ªæº' >> README_IPV6.md
        echo '"https://raw.githubusercontent.com/example/ipv6.txt"  # å¸¦å¼•å·çš„URL' >> README_IPV6.md
        echo 'https://raw.githubusercontent.com/example/ipv6.txt   # ä¸å¸¦å¼•å·çš„URL' >> README_IPV6.md
        echo '2400:cb00::/32                                        # ç›´æ¥IPv6åœ°å€' >> README_IPV6.md
        echo '2606:4700::/32' >> README_IPV6.md
        echo '# æ³¨é‡Šè¡Œä¼šè¢«å¿½ç•¥' >> README_IPV6.md
        echo '```' >> README_IPV6.md
        echo "" >> README_IPV6.md
        
        echo "### å¤„ç†åæ ¼å¼" >> README_IPV6.md
        echo '```' >> README_IPV6.md
        if [ -s ipv6_dealwith_ips.txt ]; then
          head -5 ipv6_dealwith_ips.txt | sed 's/^/  /' >> README_IPV6.md
        else
          echo "# æš‚æ— æ•°æ®" >> README_IPV6.md
        fi
        echo '```' >> README_IPV6.md
        echo "" >> README_IPV6.md
        
        echo "## ä½¿ç”¨åœºæ™¯" >> README_IPV6.md
        echo "1. **ä»£ç†é…ç½®**: ç”¨äº Clashã€V2Ray ç­‰ä»£ç†è½¯ä»¶çš„è§„åˆ™é…ç½®" >> README_IPV6.md
        echo "2. **é˜²ç«å¢™è§„åˆ™**: ç”¨äºé…ç½®é˜²ç«å¢™çš„å…è®¸/æ‹’ç»è§„åˆ™" >> README_IPV6.md
        echo "3. **ç½‘ç»œæµ‹è¯•**: ç”¨äºæµ‹è¯• IPv6 è¿æ¥" >> README_IPV6.md
        echo "" >> README_IPV6.md
        echo "## è‡ªåŠ¨æ›´æ–°" >> README_IPV6.md
        echo "æ­¤æ–‡ä»¶ç”± GitHub Actions è‡ªåŠ¨æ›´æ–°ï¼Œæ›´æ–°é¢‘ç‡ä¸ºæ¯6å°æ—¶ä¸€æ¬¡ã€‚" >> README_IPV6.md

    - name: Commit changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        git add ipv6_dealwith_ips.txt README_IPV6.md processed_sources.txt
        
        if git diff --cached --quiet; then
          echo "ğŸ”„ æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          final_count=$(wc -l < ipv6_dealwith_ips.txt 2>/dev/null || echo "0")
          git commit -m "chore: update processed IPv6 addresses from multiple sources
        
          - Total addresses: $final_count
          - Sources: from best_cf_ipv6.txt
          - Format: [IPv6]:443
          - Time: $(date +'%Y-%m-%d %H:%M')"
          git push
          echo "âœ… å·²æäº¤æ›´æ–°"
        fi
