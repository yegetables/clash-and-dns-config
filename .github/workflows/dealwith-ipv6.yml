name: Process IPv6 Addresses

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/process-ipv6.yml'

permissions:
  contents: write

jobs:
  process-ipv6:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download and process IPv6
      run: |
        set -e
        
        # é…ç½®
        SOURCE_URL="https://raw.githubusercontent.com/ymyuuu/IPDB/refs/heads/main/BestCF/bestcfv6.txt"
        ORIGINAL_FILE="bestcfv6_original.txt"
        PROCESSED_FILE="ipv6_dealwith_ips.txt"
        
        echo "ğŸ”— ä¸‹è½½æº: $SOURCE_URL"
        
        # ä¸‹è½½åŸå§‹æ–‡ä»¶
        curl -s -f "$SOURCE_URL" -o "$ORIGINAL_FILE" || {
          echo "âŒ ä¸‹è½½å¤±è´¥"
          exit 1
        }
        
        # éªŒè¯æ–‡ä»¶å†…å®¹
        if [ ! -s "$ORIGINAL_FILE" ]; then
          echo "âŒ ä¸‹è½½çš„æ–‡ä»¶ä¸ºç©º"
          exit 1
        fi
        
        echo "ğŸ“Š åŸå§‹æ–‡ä»¶ä¿¡æ¯:"
        echo "  è¡Œæ•°: $(wc -l < "$ORIGINAL_FILE")"
        echo "  å¤§å°: $(wc -c < "$ORIGINAL_FILE") å­—èŠ‚"
        
        # ç›´æ¥ä½¿ç”¨ sed å¤„ç†ï¼Œé¿å…å¤æ‚çš„ heredoc
        echo "ğŸ”„ æ­£åœ¨å¤„ç† IPv6 åœ°å€..."
        
        # ä½¿ç”¨ä½ çš„åŸå§‹ sed å‘½ä»¤
        sed -E '/^$/d; s/^([0-9a-fA-F:]*::[0-9a-fA-F:]+|[0-9a-fA-F:]+::[0-9a-fA-F:]*|([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4})$/[\1]:443/' "$ORIGINAL_FILE" > "$PROCESSED_FILE"
        
        # æ˜¾ç¤ºç»“æœ
        echo "ğŸ“‹ ç»“æœé¢„è§ˆ:"
        echo "--- å‰5è¡Œ ---"
        head -5 "$PROCESSED_FILE"
        echo "--- å5è¡Œ ---"
        tail -5 "$PROCESSED_FILE"
        
        echo "ğŸ“Š å¤„ç†å®Œæˆç»Ÿè®¡:"
        echo "  åŸå§‹è¡Œæ•°: $(wc -l < "$ORIGINAL_FILE")"
        echo "  å¤„ç†åè¡Œæ•°: $(wc -l < "$PROCESSED_FILE")"

    - name: Generate README
      run: |
        # ç”Ÿæˆ README æ–‡ä»¶
        echo "# IPv6 Address Processing Results" > README_IPV6.md
        echo "" >> README_IPV6.md
        echo "## æ›´æ–°ä¿¡æ¯" >> README_IPV6.md
        echo "- **æœ€åæ›´æ–°æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> README_IPV6.md
        echo "- **åŸå§‹æ–‡ä»¶**: [bestcfv6_original.txt](bestcfv6_original.txt)" >> README_IPV6.md
        echo "- **å¤„ç†åæ–‡ä»¶**: [ipv6_dealwith_ips.txt](ipv6_dealwith_ips.txt)" >> README_IPV6.md
        echo "" >> README_IPV6.md
        echo "## ç»Ÿè®¡ä¿¡æ¯" >> README_IPV6.md
        echo "- åŸå§‹ IPv6 åœ°å€æ•°: $(wc -l < bestcfv6_original.txt)" >> README_IPV6.md
        echo "- å¤„ç†åçš„åœ°å€æ•°: $(wc -l < ipv6_dealwith_ips.txt)" >> README_IPV6.md
        echo "" >> README_IPV6.md
        echo "## å¤„ç†è¯´æ˜" >> README_IPV6.md
        echo "å°†æ™®é€šçš„ IPv6 åœ°å€è½¬æ¢ä¸º \`[IPv6]:443\` æ ¼å¼ï¼Œç”¨äºä»£ç†æˆ–é˜²ç«å¢™è§„åˆ™é…ç½®ã€‚" >> README_IPV6.md
        echo "" >> README_IPV6.md
        echo "## æ–‡ä»¶æ ¼å¼ç¤ºä¾‹" >> README_IPV6.md
        echo "### åŸå§‹æ ¼å¼" >> README_IPV6.md
        echo '```' >> README_IPV6.md
        head -3 bestcfv6_original.txt | sed 's/^/  /' >> README_IPV6.md
        echo '```' >> README_IPV6.md
        echo "" >> README_IPV6.md
        echo "### å¤„ç†åæ ¼å¼" >> README_IPV6.md
        echo '```' >> README_IPV6.md
        head -3 ipv6_dealwith_ips.txt | sed 's/^/  /' >> README_IPV6.md
        echo '```' >> README_IPV6.md
        echo "" >> README_IPV6.md
        echo "## ä½¿ç”¨åœºæ™¯" >> README_IPV6.md
        echo "1. **ä»£ç†é…ç½®**: ç”¨äº Clashã€V2Ray ç­‰ä»£ç†è½¯ä»¶çš„è§„åˆ™é…ç½®" >> README_IPV6.md
        echo "2. **é˜²ç«å¢™è§„åˆ™**: ç”¨äºé…ç½®é˜²ç«å¢™çš„å…è®¸/æ‹’ç»è§„åˆ™" >> README_IPV6.md
        echo "3. **ç½‘ç»œæµ‹è¯•**: ç”¨äºæµ‹è¯• IPv6 è¿æ¥" >> README_IPV6.md
        echo "" >> README_IPV6.md
        echo "## è‡ªåŠ¨æ›´æ–°" >> README_IPV6.md
        echo "æ­¤æ–‡ä»¶ç”± GitHub Actions è‡ªåŠ¨æ›´æ–°ï¼Œæ›´æ–°é¢‘ç‡ä¸ºæ¯6å°æ—¶ä¸€æ¬¡ã€‚" >> README_IPV6.md

    - name: Commit changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        git add bestcfv6_original.txt ipv6_dealwith_ips.txt README_IPV6.md
        
        if git diff --cached --quiet; then
          echo "ğŸ”„ æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          original_count=$(wc -l < bestcfv6_original.txt)
          processed_count=$(wc -l < ipv6_dealwith_ips.txt)
          git commit -m "chore: update processed IPv6 addresses
        
          - Original: $original_count addresses
          - Processed: $processed_count addresses
          - Format: [IPv6]:443
          - Time: $(date +'%Y-%m-%d %H:%M')"
          git push
          echo "âœ… å·²æäº¤æ›´æ–°"
        fi
