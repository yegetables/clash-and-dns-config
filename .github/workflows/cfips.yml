name: Update CloudFlare IP Ranges

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 3:24 æ‰§è¡Œ (å¯¹åº” UTC+8 æ—¶é—´ 11:24)
    - cron: '24 3 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/cfips.yml'

jobs:
  update-ips:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup UTC+8 timezone for logging
      run: |
        echo "TZ=Asia/Shanghai" >> $GITHUB_ENV
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Workflow started"

    - name: Download CloudFlare IPv4 ranges
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Downloading CloudFlare IPv4 ranges..."
        curl -s -L "https://www.cloudflare.com/ips-v4" -o cfips/cfipv4_raw.txt
        # æ¸…ç†å¹¶éªŒè¯IPv4æ ¼å¼ï¼Œå¿½ç•¥æ— æ•ˆè¡Œç»§ç»­å¤„ç†
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Cleaning and validating IPv4 ranges..."
        valid_count=0
        invalid_count=0
        
        grep -v '^#' cfips/cfipv4_raw.txt | grep -v '^$' | sed 's/\r//g' | awk '{print $1}' | while read -r line; do
          # åˆ†å‰²IPå’Œæ©ç 
          ip_part=$(echo "$line" | cut -d'/' -f1)
          mask_part=$(echo "$line" | cut -d'/' -f2 2>/dev/null)
          
          # æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„IPv4 CIDR
          if [[ "$line" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}$ ]]; then
            # æ£€æŸ¥æ©ç æ˜¯å¦åœ¨1-32èŒƒå›´å†…
            if [[ "$mask_part" -ge 1 && "$mask_part" -le 32 ]]; then
              echo "$line"
              valid_count=$((valid_count + 1))
            else
              echo "[WARNING] Skipping invalid IPv4 mask ($mask_part): $line" >&2
              invalid_count=$((invalid_count + 1))
            fi
          else
            # å°è¯•ä»æ··åˆè¡Œä¸­æå–æœ‰æ•ˆIPv4
            found_valid=false
            for item in $line; do
              if [[ "$item" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}$ ]]; then
                item_mask=$(echo "$item" | cut -d'/' -f2)
                if [[ "$item_mask" -ge 1 && "$item_mask" -le 32 ]]; then
                  echo "$item"
                  valid_count=$((valid_count + 1))
                  found_valid=true
                fi
              fi
            done
            if [[ "$found_valid" == false ]]; then
              echo "[WARNING] No valid IPv4 found in line: $line" >&2
              invalid_count=$((invalid_count + 1))
            fi
          fi
        done | sort -u > cfips/cfipv4.txt
        
        # ç»Ÿè®¡ä¿¡æ¯
        ipv4_count=$(wc -l < cfips/cfipv4.txt)
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Processed $ipv4_count valid IPv4 ranges"
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Skipped $invalid_count invalid IPv4 lines"

    - name: Download CloudFlare IPv6 ranges
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Downloading CloudFlare IPv6 ranges..."
        curl -s -L "https://www.cloudflare.com/ips-v6" -o cfips/cfipv6_raw.txt
        # æ¸…ç†å¹¶éªŒè¯IPv6æ ¼å¼ï¼Œå¿½ç•¥æ— æ•ˆè¡Œç»§ç»­å¤„ç†
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Cleaning and validating IPv6 ranges..."
        valid_count=0
        invalid_count=0
        
        grep -v '^#' cfips/cfipv6_raw.txt | grep -v '^$' | sed 's/\r//g' | awk '{print $1}' | while read -r line; do
          # åˆ†å‰²IPå’Œæ©ç 
          ip_part=$(echo "$line" | cut -d'/' -f1)
          mask_part=$(echo "$line" | cut -d'/' -f2 2>/dev/null)
          
          # æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„IPv6 CIDR
          if [[ "$line" =~ ^[a-fA-F0-9:]+/[0-9]{1,3}$ ]]; then
            # æ£€æŸ¥æ©ç æ˜¯å¦åœ¨1-128èŒƒå›´å†…
            if [[ "$mask_part" -ge 1 && "$mask_part" -le 128 ]]; then
              echo "$line"
              valid_count=$((valid_count + 1))
            else
              echo "[WARNING] Skipping invalid IPv6 mask ($mask_part): $line" >&2
              invalid_count=$((invalid_count + 1))
            fi
          else
            # å°è¯•ä»æ··åˆè¡Œä¸­æå–æœ‰æ•ˆIPv6
            found_valid=false
            for item in $line; do
              if [[ "$item" =~ ^[a-fA-F0-9:]+/[0-9]{1,3}$ ]]; then
                item_mask=$(echo "$item" | cut -d'/' -f2)
                if [[ "$item_mask" -ge 1 && "$item_mask" -le 128 ]]; then
                  echo "$item"
                  valid_count=$((valid_count + 1))
                  found_valid=true
                fi
              fi
            done
            if [[ "$found_valid" == false ]]; then
              echo "[WARNING] No valid IPv6 found in line: $line" >&2
              invalid_count=$((invalid_count + 1))
            fi
          fi
        done | sort -u > cfips/cfipv6.txt
        
        ipv6_count=$(wc -l < cfips/cfipv6.txt)
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Processed $ipv6_count valid IPv6 ranges"
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Skipped $invalid_count invalid IPv6 lines"
    - name: Validate downloaded files
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Validating downloaded files..."
        
        echo "=== IPv4 Validation ==="
        echo "Total lines in cfipv4.txt: $(wc -l < cfips/cfipv4.txt)"
        
        # æ£€æŸ¥IPv4æ©ç èŒƒå›´ï¼ˆåªæŠ¥å‘Šï¼Œä¸é€€å‡ºï¼‰
        echo "Checking IPv4 mask ranges..."
        invalid_ipv4_count=0
        while read -r line; do
          mask=$(echo "$line" | cut -d'/' -f2)
          if [[ "$mask" -lt 1 || "$mask" -gt 32 ]]; then
            echo "[WARNING] IPv4 with invalid mask ($mask): $line" >&2
            invalid_ipv4_count=$((invalid_ipv4_count + 1))
          fi
        done < cfips/cfipv4.txt
        
        if [[ $invalid_ipv4_count -gt 0 ]]; then
          echo "[WARNING] Found $invalid_ipv4_count IPv4 lines with invalid masks (1-32 expected)"
        else
          echo "âœ“ All IPv4 masks are valid (1-32)"
        fi
        
        echo ""
        echo "=== IPv6 Validation ==="
        echo "Total lines in cfipv6.txt: $(wc -l < cfips/cfipv6.txt)"
        
        # æ£€æŸ¥IPv6æ©ç èŒƒå›´ï¼ˆåªæŠ¥å‘Šï¼Œä¸é€€å‡ºï¼‰
        echo "Checking IPv6 mask ranges..."
        invalid_ipv6_count=0
        while read -r line; do
          mask=$(echo "$line" | cut -d'/' -f2)
          if [[ "$mask" -lt 1 || "$mask" -gt 128 ]]; then
            echo "[WARNING] IPv6 with invalid mask ($mask): $line" >&2
            invalid_ipv6_count=$((invalid_ipv6_count + 1))
          fi
        done < cfips/cfipv6.txt
        
        if [[ $invalid_ipv6_count -gt 0 ]]; then
          echo "[WARNING] Found $invalid_ipv6_count IPv6 lines with invalid masks (1-128 expected)"
        else
          echo "âœ“ All IPv6 masks are valid (1-128)"
        fi
    - name: Merge IP ranges to cfips.txt
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Merging IPv4 and IPv6 ranges..."
        
        # ç›´æ¥åˆå¹¶å·²éªŒè¯çš„æ–‡ä»¶
        cat cfips/cfipv4.txt cfips/cfipv6.txt | sort -u > cfips/cfips.txt
        
        total_count=$(wc -l < cfips/cfips.txt)
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Merged complete: $total_count total unique ranges"
        
        # éªŒè¯åˆå¹¶ç»“æœ
        echo ""
        echo "=== Final validation of cfips.txt ==="
        echo "Total lines: $(wc -l < cfips/cfips.txt)"
        
        # åˆ†ç±»ç»Ÿè®¡
        ipv4_in_merged=$(grep -c '^[0-9]' cfips/cfips.txt)
        ipv6_in_merged=$(grep -c ':' cfips/cfips.txt)
        echo "IPv4 in merged file: $ipv4_in_merged"
        echo "IPv6 in merged file: $ipv6_in_merged"
        
        # æ£€æŸ¥åˆå¹¶æ–‡ä»¶ä¸­æ˜¯å¦æœ‰æ— æ•ˆè¡Œ
        echo "Checking for invalid lines in merged file..."
        invalid_lines=0
        while read -r line; do
          if [[ "$line" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}$ ]]; then
            mask=$(echo "$line" | cut -d'/' -f2)
            if [[ "$mask" -lt 1 || "$mask" -gt 32 ]]; then
              echo "ERROR: Invalid IPv4 mask in merged file: $line"
              invalid_lines=$((invalid_lines + 1))
            fi
          elif [[ "$line" =~ ^[a-fA-F0-9:]+/[0-9]{1,3}$ ]]; then
            mask=$(echo "$line" | cut -d'/' -f2)
            if [[ "$mask" -lt 1 || "$mask" -gt 128 ]]; then
              echo "ERROR: Invalid IPv6 mask in merged file: $line"
              invalid_lines=$((invalid_lines + 1))
            fi
          else
            echo "ERROR: Invalid format in merged file: $line"
            invalid_lines=$((invalid_lines + 1))
          fi
        done < cfips/cfips.txt
        
        if [[ $invalid_lines -gt 0 ]]; then
          echo "ERROR: Found $invalid_lines invalid lines in merged file"
          exit 1
        else
          echo "âœ“ All lines in merged file are valid"
        fi

    - name: Generate statistics for logging
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Generating statistics..."
        timestamp=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')
        ipv4_count=$(wc -l < cfips/cfipv4.txt)
        ipv6_count=$(wc -l < cfips/cfipv6.txt)
        total_count=$(wc -l < cfips/cfips.txt)
        
        echo "=== CloudFlare IP Ranges Statistics ==="
        echo "Update time: $timestamp"
        echo "IPv4 ranges: $ipv4_count (mask: 1-32)"
        echo "IPv6 ranges: $ipv6_count (mask: 1-128)"
        echo "Total ranges: $total_count"
        echo ""
        
        # ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ç”¨äºåç»­æ­¥éª¤
        echo "$ipv4_count" > /tmp/ipv4_count.txt
        echo "$ipv6_count" > /tmp/ipv6_count.txt
        echo "$total_count" > /tmp/total_count.txt
        echo "$timestamp" > /tmp/timestamp.txt

    - name: Preview final results
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Final file preview:"
        echo ""
        echo "=== cfipv4.txt sample ==="
        echo "First 5 lines:"
        head -5 cfips/cfipv4.txt
        echo "..."
        echo "Last 5 lines:"
        tail -5 cfips/cfipv4.txt
        echo ""
        echo "=== cfipv6.txt sample ==="
        echo "First 5 lines:"
        head -5 cfips/cfipv6.txt
        echo "..."
        echo "Last 5 lines:"
        tail -5 cfips/cfipv6.txt
        echo ""
        echo "=== cfips.txt sample ==="
        echo "First 10 lines:"
        head -10 cfips/cfips.txt
        echo "..."
        echo "Last 10 lines:"
        tail -10 cfips/cfips.txt

    - name: Check for changes
      id: check_changes
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Checking for file changes..."
        
        # æ·»åŠ æ¸…ç†åçš„æ–‡ä»¶
        git add cfips/cfipv4.txt cfips/cfipv6.txt cfips/cfips.txt
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --cached --quiet; then
          echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] No changes detected in IP files"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "status=no_changes" >> $GITHUB_OUTPUT
        else
          echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Changes detected in IP files"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "status=changes_found" >> $GITHUB_OUTPUT
          timestamp=$(TZ=Asia/Shanghai date '+%Y%m%d_%H%M%S')
          echo "timestamp=$timestamp" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºå˜æ›´æ‘˜è¦
          echo "Files changed:"
          git diff --cached --name-only
          echo ""
          echo "Line changes:"
          git diff --cached --stat
        fi

    - name: Commit and push changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Committing changes..."
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ä»ä¸´æ—¶æ–‡ä»¶è¯»å–ç»Ÿè®¡ä¿¡æ¯
        ipv4_count=$(cat /tmp/ipv4_count.txt)
        ipv6_count=$(cat /tmp/ipv6_count.txt)
        total_count=$(cat /tmp/total_count.txt)
        timestamp=$(cat /tmp/timestamp.txt)
        
        commit_msg="Update CloudFlare IP ranges ($timestamp)

        â€¢ Total IP ranges: $total_count
        â€¢ IPv4 ranges: $ipv4_count (mask: 1-32)
        â€¢ IPv6 ranges: $ipv6_count (mask: 1-128)

        Auto-updated by GitHub Actions workflow"
        
        git commit -m "$commit_msg"
        git push origin HEAD:${{ github.ref_name }}
        
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Changes pushed successfully"
        echo "Commit SHA: $(git rev-parse HEAD)"

    - name: Skip commit (no changes)
      if: steps.check_changes.outputs.has_changes == 'false'
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m%d %H:%M:%S %Z')] No changes detected, skipping commit"
        echo "All CloudFlare IP ranges are already up to date"
        
        # æ˜¾ç¤ºå½“å‰ç»Ÿè®¡ä¿¡æ¯
        ipv4_count=$(cat /tmp/ipv4_count.txt)
        ipv6_count=$(cat /tmp/ipv6_count.txt)
        total_count=$(cat /tmp/total_count.txt)
        timestamp=$(cat /tmp/timestamp.txt)
        
        echo "Current status:"
        echo "- IPv4 ranges: $ipv4_count (valid masks: 1-32)"
        echo "- IPv6 ranges: $ipv6_count (valid masks: 1-128)"
        echo "- Total ranges: $total_count"
        echo "- Last check: $timestamp"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cloudflare-ip-ranges
        path: cfips/
        retention-days: 30
      if: always()

    - name: Cleanup temporary files
      if: always()
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Cleaning up temporary files..."
        # æ¸…ç†åŸå§‹æ–‡ä»¶
        rm -f cfips/cfipv4_raw.txt cfips/cfipv6_raw.txt
        # æ¸…ç†ä¸´æ—¶ç»Ÿè®¡æ–‡ä»¶
        rm -f /tmp/ipv4_count.txt /tmp/ipv6_count.txt /tmp/total_count.txt /tmp/timestamp.txt
        echo "Cleanup completed"

    - name: Workflow summary
      run: |
        echo ""
        echo "=========================================="
        echo "CLOUDFLARE IP RANGES UPDATE - SUMMARY"
        echo "=========================================="
        echo "Workflow: ${{ github.workflow }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Run URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "Time: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')"
        echo ""
        
        if [[ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]]; then
          echo "âœ… RESULT: IP ranges updated successfully"
          echo "ğŸ“Š Status: Changes were detected and committed"
        else
          echo "âœ… RESULT: IP ranges are up to date"
          echo "ğŸ“Š Status: No changes needed"
        fi
        
        echo "ğŸ“ Files in cfips/:"
        ls -la cfips/*.txt | awk '{print "- " $9 " (" $5 " bytes)"}'
        echo "ğŸ“¦ Artifact: cloudflare-ip-ranges"
        echo "=========================================="