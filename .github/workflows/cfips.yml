name: Update CloudFlare IP Ranges

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 3:24 æ‰§è¡Œ (å¯¹åº” UTC+8 æ—¶é—´ 11:24)
    - cron: '24 3 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/cfips.yml'

jobs:
  update-ips:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup UTC+8 timezone for logging
      run: |
        echo "TZ=Asia/Shanghai" >> $GITHUB_ENV
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Workflow started"

    - name: Download CloudFlare IPv4 ranges
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Downloading CloudFlare IPv4 ranges..."
        # ä½¿ç”¨ -L è·Ÿéšé‡å®šå‘ï¼Œç¡®ä¿è·å–å®Œæ•´å†…å®¹
        curl -s -L "https://www.cloudflare.com/ips-v4" -o cfips/cfipv4_raw.txt
        # æ¸…ç†æ–‡ä»¶ï¼šç§»é™¤ç©ºè¡Œã€æ³¨é‡Šï¼Œç¡®ä¿æ¯è¡Œåªæœ‰ä¸€ä¸ªIPæ®µ
        grep -v '^#' cfips/cfipv4_raw.txt | grep -v '^$' | sed 's/\r//g' | awk '{print $1}' | grep -E '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}' > cfips/cfipv4.txt
        ipv4_count=$(wc -l < cfips/cfipv4.txt)
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Downloaded and cleaned $ipv4_count IPv4 ranges"

    - name: Download CloudFlare IPv6 ranges
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Downloading CloudFlare IPv6 ranges..."
        # ä½¿ç”¨ -L è·Ÿéšé‡å®šå‘ï¼Œç¡®ä¿è·å–å®Œæ•´å†…å®¹
        curl -s -L "https://www.cloudflare.com/ips-v6" -o cfips/cfipv6_raw.txt
        # æ¸…ç†æ–‡ä»¶ï¼šç§»é™¤ç©ºè¡Œã€æ³¨é‡Šï¼Œç¡®ä¿æ¯è¡Œåªæœ‰ä¸€ä¸ªIPæ®µ
        grep -v '^#' cfips/cfipv6_raw.txt | grep -v '^$' | sed 's/\r//g' | awk '{print $1}' | grep -E '^[a-fA-F0-9:]+/[0-9]{1,3}' > cfips/cfipv6.txt
        ipv6_count=$(wc -l < cfips/cfipv6.txt)
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Downloaded and cleaned $ipv6_count IPv6 ranges"

    - name: Validate downloaded files
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Validating downloaded files..."
        
        echo "=== Checking IPv4 file ==="
        echo "Total lines in cfipv4_raw.txt: $(wc -l < cfips/cfipv4_raw.txt)"
        echo "Total lines in cfipv4.txt: $(wc -l < cfips/cfipv4.txt)"
        echo "Sample IPv4 entries:"
        head -5 cfips/cfipv4.txt
        
        echo ""
        echo "=== Checking IPv6 file ==="
        echo "Total lines in cfipv6_raw.txt: $(wc -l < cfips/cfipv6_raw.txt)"
        echo "Total lines in cfipv6.txt: $(wc -l < cfips/cfipv6.txt)"
        echo "Sample IPv6 entries:"
        head -5 cfips/cfipv6.txt
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ··åˆè¡Œ
        echo ""
        echo "=== Checking for mixed lines ==="
        if grep -E '^[0-9].*:[a-fA-F0-9]' cfips/cfipv4.txt cfips/cfipv6.txt 2>/dev/null; then
          echo "WARNING: Found mixed IPv4/IPv6 lines!"
        else
          echo "No mixed IPv4/IPv6 lines found."
        fi

    - name: Merge IP ranges to cfips.txt
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Merging IPv4 and IPv6 ranges..."
        
        # æ–¹æ³•1ï¼šä½¿ç”¨catåˆå¹¶ï¼Œç„¶åè¿›è¡Œæ¸…ç†
        echo "Method 1: Simple merge"
        cat cfips/cfipv4.txt cfips/cfipv6.txt > cfips/cfips_temp1.txt
        
        # æ–¹æ³•2ï¼šé€è¡Œå¤„ç†ï¼Œç¡®ä¿æ¯è¡Œåªæœ‰ä¸€ä¸ªCIDR
        echo "Method 2: Process each line carefully"
        {
          # å¤„ç†IPv4æ–‡ä»¶
          while IFS= read -r line; do
            # ç§»é™¤æ‰€æœ‰ç©ºç™½å­—ç¬¦ï¼Œç„¶åæŒ‰ç©ºæ ¼åˆ†å‰²
            cleaned=$(echo "$line" | tr -d '\r' | xargs)
            for item in $cleaned; do
              # åªè¾“å‡ºæœ‰æ•ˆçš„CIDR
              if echo "$item" | grep -qE '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}$'; then
                echo "$item"
              fi
            done
          done < cfips/cfipv4_raw.txt
          
          # å¤„ç†IPv6æ–‡ä»¶
          while IFS= read -r line; do
            # ç§»é™¤æ‰€æœ‰ç©ºç™½å­—ç¬¦ï¼Œç„¶åæŒ‰ç©ºæ ¼åˆ†å‰²
            cleaned=$(echo "$line" | tr -d '\r' | xargs)
            for item in $cleaned; do
              # åªè¾“å‡ºæœ‰æ•ˆçš„IPv6 CIDR
              if echo "$item" | grep -qE '^[a-fA-F0-9:]+/[0-9]{1,3}$'; then
                echo "$item"
              fi
            done
          done < cfips/cfipv6_raw.txt
        } | sort -u > cfips/cfips.txt
        
        total_count=$(wc -l < cfips/cfips.txt)
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Merged complete: $total_count total unique ranges"
        
        # éªŒè¯åˆå¹¶ç»“æœ
        echo ""
        echo "=== Validation of merged file ==="
        echo "Total lines in cfips.txt: $(wc -l < cfips/cfips.txt)"
        echo "Checking for any mixed lines in cfips.txt:"
        if grep -E '^[0-9].*:[a-fA-F0-9]' cfips/cfips.txt; then
          echo "ERROR: Found mixed IPv4/IPv6 lines in merged file!"
          echo "First few problematic lines:"
          grep -E '^[0-9].*:[a-fA-F0-9]' cfips/cfips.txt | head -5
          exit 1
        else
          echo "âœ“ No mixed IPv4/IPv6 lines found in merged file."
        fi

    - name: Generate statistics for logging
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Generating statistics..."
        timestamp=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')
        ipv4_count=$(wc -l < cfips/cfipv4.txt)
        ipv6_count=$(wc -l < cfips/cfipv6.txt)
        total_count=$(wc -l < cfips/cfips.txt)
        
        echo "=== CloudFlare IP Ranges Statistics ==="
        echo "Update time: $timestamp"
        echo "IPv4 ranges: $ipv4_count"
        echo "IPv6 ranges: $ipv6_count"
        echo "Total ranges: $total_count"
        echo ""
        
        # ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ç”¨äºåç»­æ­¥éª¤
        echo "$ipv4_count" > /tmp/ipv4_count.txt
        echo "$ipv6_count" > /tmp/ipv6_count.txt
        echo "$total_count" > /tmp/total_count.txt
        echo "$timestamp" > /tmp/timestamp.txt

    - name: Preview final results
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Final file preview:"
        echo ""
        echo "=== cfipv4.txt (first 10 lines) ==="
        head -10 cfips/cfipv4.txt
        echo ""
        echo "=== cfipv6.txt (first 10 lines) ==="
        head -10 cfips/cfipv6.txt
        echo ""
        echo "=== cfips.txt (first 15 lines) ==="
        head -15 cfips/cfips.txt
        echo ""
        echo "=== cfips.txt (last 10 lines) ==="
        tail -10 cfips/cfips.txt
        echo ""
        echo "=== File sizes ==="
        ls -lh cfips/*.txt

    - name: Check for changes
      id: check_changes
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Checking for file changes..."
        
        # åªæ·»åŠ æ¸…ç†åçš„æ–‡ä»¶ï¼Œä¸æ·»åŠ åŸå§‹æ–‡ä»¶
        git add cfips/cfipv4.txt cfips/cfipv6.txt cfips/cfips.txt
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --cached --quiet; then
          echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] No changes detected in IP files"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "status=no_changes" >> $GITHUB_OUTPUT
        else
          echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Changes detected in IP files"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "status=changes_found" >> $GITHUB_OUTPUT
          timestamp=$(TZ=Asia/Shanghai date '+%Y%m%d_%H%M%S')
          echo "timestamp=$timestamp" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºå˜æ›´æ‘˜è¦
          echo "Changes summary:"
          git diff --cached --name-only
          echo ""
          echo "Line count changes:"
          git diff --cached --stat
        fi

    - name: Commit and push changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Committing changes..."
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ä»ä¸´æ—¶æ–‡ä»¶è¯»å–ç»Ÿè®¡ä¿¡æ¯
        ipv4_count=$(cat /tmp/ipv4_count.txt)
        ipv6_count=$(cat /tmp/ipv6_count.txt)
        total_count=$(cat /tmp/total_count.txt)
        timestamp=$(cat /tmp/timestamp.txt)
        
        commit_msg="Update CloudFlare IP ranges ($timestamp)

        â€¢ Total IP ranges: $total_count
        â€¢ IPv4 ranges: $ipv4_count
        â€¢ IPv6 ranges: $ipv6_count

        Auto-updated by GitHub Actions workflow"
        
        git commit -m "$commit_msg"
        git push origin HEAD:${{ github.ref_name }}
        
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Changes pushed successfully"
        echo "Commit SHA: $(git rev-parse HEAD)"

    - name: Skip commit (no changes)
      if: steps.check_changes.outputs.has_changes == 'false'
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] No changes detected, skipping commit"
        echo "All CloudFlare IP ranges are already up to date"
        
        # æ˜¾ç¤ºå½“å‰ç»Ÿè®¡ä¿¡æ¯
        ipv4_count=$(cat /tmp/ipv4_count.txt)
        ipv6_count=$(cat /tmp/ipv6_count.txt)
        total_count=$(cat /tmp/total_count.txt)
        timestamp=$(cat /tmp/timestamp.txt)
        
        echo "Current status:"
        echo "- IPv4 ranges: $ipv4_count"
        echo "- IPv6 ranges: $ipv6_count"
        echo "- Total ranges: $total_count"
        echo "- Last check: $timestamp"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cloudflare-ip-ranges
        path: cfips/
        retention-days: 30
      if: always()

    - name: Cleanup temporary files
      if: always()
      run: |
        echo "[$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')] Cleaning up temporary files..."
        # æ¸…ç†åŸå§‹æ–‡ä»¶
        rm -f cfips/cfipv4_raw.txt cfips/cfipv6_raw.txt cfips/cfips_temp1.txt
        # æ¸…ç†ä¸´æ—¶ç»Ÿè®¡æ–‡ä»¶
        rm -f /tmp/ipv4_count.txt /tmp/ipv6_count.txt /tmp/total_count.txt /tmp/timestamp.txt
        echo "Cleanup completed"

    - name: Workflow summary
      run: |
        echo ""
        echo "=========================================="
        echo "CLOUDFLARE IP RANGES UPDATE - SUMMARY"
        echo "=========================================="
        echo "Workflow: ${{ github.workflow }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Run URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        
        if [[ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]]; then
          echo "âœ… RESULT: IP ranges updated successfully"
          echo "ğŸ“Š Status: Changes were detected and committed"
          echo "ğŸ•’ Time: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')"
        else
          echo "âœ… RESULT: IP ranges are up to date"
          echo "ğŸ“Š Status: No changes needed"
          echo "ğŸ•’ Time: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')"
        fi
        
        echo "ğŸ“ Files updated in: cfips/"
        echo "ğŸ“¦ Artifact: cloudflare-ip-ranges"
        echo "=========================================="